<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --light: #f8f9fa;
            --text: #2c3e50;
            --border: #eaeaea;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            margin: 0;
            padding: 0;
            background-color: var(--light);
            color: var(--text);
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            padding: 20px;
            color: white;
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .content {
            flex: 1;
            padding: 40px;
            background-color: var(--light);
        }

        .user-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .user-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        #attendance-details {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        #attendance-details h3 {
            margin-bottom: 20px;
        }

        #attendance-details label {
            font-weight: 500;
            margin-right: 10px;
        }

        #attendance-details select {
            margin-right: 20px;
        }

        #attendance-details input[type="date"] {
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            transition: border-color 0.3s ease;
        }

        #attendance-details input[type="date"]:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        #attendance-details button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
            transition: background 0.3s ease;
        }

        #attendance-details button:hover {
            background: var(--secondary);
        }

        .attendance-table {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
        }

        .attendance-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
        }

        .attendance-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }

        .attendance-table tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .attendance-table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .attendance-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }

        .search-bar {
            background: white;
            border: 2px solid var(--border);
            border-radius: 30px;
            padding: 12px 25px;
            width: 100%;
            max-width: 400px;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .search-bar:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 280%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: var(--text);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--accent);
        }

        select {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        select:hover {
            background: var(--secondary);
        }

        h2,
        h3,
        h4 {
            color: var(--text);
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .content {
                padding: 20px;
            }

            .modal-content {
                width: 90%;
            }
        }

        /* Create Tickets Form Styling */
        #create-tickets form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            max-width: 600px;
            margin: 20px auto;
        }

        #create-tickets label {
            display: block;
            margin: 15px 0 5px;
            color: var(--text);
            font-weight: 500;
        }

        #create-tickets input[type="text"],
        #create-tickets input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #create-tickets input[type="text"]:focus,
        #create-tickets input[type="date"]:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        #create-tickets select {
            width: 100%;
            margin: 0 0 15px;
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
        }

        #create-tickets select:hover {
            background: white;
            border-color: var(--accent);
        }

        #create-tickets input[type="submit"] {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        #create-tickets input[type="submit"]:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #create-tickets textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: all 0.3s ease;
            resize: vertical;
        }

        #create-tickets textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .project-tickets {
            background: #ffffff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ticket-list {
            list-style-type: none;
            padding: 0;
        }

        .ticket-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.3s ease;
        }

        .ticket-item:last-child {
            border-bottom: none;
        }

        .ticket-item:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .view-details {
            color: var(--accent);
            text-decoration: underline;
            transition: color 0.3s ease;
        }

        .view-details:hover {
            color: #2980b9;
        }

        .flash-messages {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .flash-messages.success {
            background-color: #d4edda;
            color: #155724;
        }

        .flash-messages.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .flash-messages ul {
            margin: 0;
            padding: 0;
            list-style-type: none;
        }

        .flash-messages li {
            margin-bottom: 5px;
        }

        .date-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: -10px;
            margin-bottom: 15px;
        }

        #create-tickets input[type="date"] {
            min-width: 200px;
        }

        .Viewbtn {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            margin: 15px;
            transition: background-color 0.3s ease;
        }

        .Viewbtn:hover {
            background-color: #0056b3;
        }

        .Downloadbtn {
            background-color: #f1f1f1;
            color: #007bff;
            padding: 10px 15px;
            border: 2px solid #007bff;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            margin: 15px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .Downloadbtn:hover {
            background-color: #e1e1e1;
        }
        
        .view-details{
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-admin {
                    background-color: #28a745;
                    padding: 10px 15px;
                    color: white;
                }

                .btn-admin:hover {
                    background-color: #218838;
                }

                .admin-comments-section {
                    margin-top: 10px;
                    padding-left: 20px;
                    font-size: 14px;
                }

                .admin-comments-section {
                    background-color: #f7f7f7;
                    border-left: 3px solid #28a745;
                    padding: 10px;
                }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2>Admin Menu</h2>
        <a href="#user-details" onclick="showSection('user-details')">User Details</a>
        <a href="#ticket-details" onclick="showSection('ticket-details')">Ticket Details</a>
        <a href="#create-tickets" onclick="showSection('create-tickets')">Create Ticket</a>
        <a href="#assigned-tickets" onclick="showSection('assigned-tickets')">Admin Assigned Ticket</a>
        <a href="#attendance-details" onclick="showSection('attendance-details')">Attendance Records</a>
        <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
    </div>

    <div class="content">
        <h2>Admin Dashboard</h2>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            <ul>
                {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% endwith %}
        <div id="user-details" class="section">
            <h3>User Details</h3>
            {% for team_name, team in teams.items() %}
            <div class="user-section">
                <h3>Team: {{ team_name }}</h3>
                {% if team_name == 'Others' %}
                <p>
                <h4>Researcher:</h4> {% for member in team.members %} {{ member[1] }} ({{ member[2] }}) {% endfor %}</p>
                {% else %}
                <p>
                <h4>Mentor:</h4> {% for mentor in team.mentor %} {{ mentor[1] }} ({{ mentor[2] }}) {% endfor %}</p>
                <h4>Members:</h4>
                <p>{% for member in team.members %} {{ member[1] }} ({{ member[2] }}) {% endfor %}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Replace the existing ticket details section with this updated version -->
        <div id="ticket-details" class="section" style="display:none;">
            <h3>Ticket Details</h3>
            <input type="text" id="searchBar" class="search-bar" placeholder="Search team by name..."
                oninput="searchUser()">

            {% for team_name, team in teams.items() %}
            {% if team_name != 'Others' %}
            <div class="user-section">
                <h4>Team: {{ team_name }}</h4>
                <p>Mentor: {% for mentor in team.mentor %} {{ mentor[1] }} ({{ mentor[2] }}) {% endfor %}</p>
                <h5>Projects:</h5>

                <!-- Create a set of unique project names -->
                {% set unique_projects = {} %}
                {% for member in team.members %}
                {% for project_info, tickets in user_tickets[member[2]].items() %}
                {% if project_info not in unique_projects %}
                {% set _ = unique_projects.update({project_info: []}) %}
                {% endif %}
                {% set _ = unique_projects[project_info].append(member[2]) %}
                {% endfor %}
                {% endfor %}

                <!-- Display unique projects with all associated members -->
                <ul>
                    {% for project_info, member_emails in unique_projects.items() %}
                    <li>
                        <strong>{{ project_info }}</strong>
                        <ul>
                            {% for member_email in member_emails %}
                            <li>
                                <a class="Viewbtn" href="#"
                                    onclick="showProjectDetails('{{ project_info }}', '{{ team_name }}', '{{ member_email }}')">
                                    View tickets by {{ member_email }}
                                </a><br>
                            </li>
                            {% endfor %}
                        </ul>
                        <!-- Display the download link -->
                        {% for project in projects %}
                        {% if project[1] == project_info %}
                        <a class="Downloadbtn" href="{{ url_for('download_project', project_id=project[0]) }}">
                            Download {{ project[1] }}
                        </a>
                        {% endif %}
                        {% endfor %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <div id="create-tickets" class="section" style="display:none;">
            <h3>Assign Tickets</h3>
            <form method="POST" action="{{ url_for('create_ticket_admin') }}" enctype="multipart/form-data">
                <label for="team_name">Select Team:</label>
                <select id="team_name" name="team_name" onchange="updateMentors()">
                    <option value="">Select a team</option>
                    {% for team_name, team in teams.items() %}
                    <option value="{{ team_name }}">{{ team_name }}</option>
                    {% endfor %}
                </select>

                <label for="mentor_name">Select Mentor/Member:</label>
                <select id="mentor_name" name="mentor_name" onchange="updateHiddenEmail()">
                    <option value="">Select Mentor/Member</option>
                    <!-- Mentors will be populated based on the selected team -->
                </select>

                <input type="hidden" id="mentor_email" name="mentor_email" value="">

                <label for="project_name">Project Name:</label>
                <input type="text" id="project_name" name="project_name" required>

                <label for="description">Description:</label>
                <textarea name="description" required></textarea>

                <label for="module_info">Project Module:</label>
                <input type="text" name="module_info" id="module_info" enabled><br>

                <label for="start_date">Ticket Start Date:</label>
                <input type="date" id="start_date" name="start_date" required>

                <label for="end_date">Ticket End Date:</label>
                <input type="date" id="end_date" name="end_date" required>

                <!-- <label for="images">Upload Images:</label>
                <input type="file" name="images" id="images" multiple><br> -->

                <input type="submit" value="Assign Ticket">
            </form>
        </div>

        <div id="assigned-tickets" class="section" style="display:none;">
            <h3>Admin Assigned Tickets</h3>
            {% for user_email, data in admin_tickets.items() %}
            <div class="user-section">
                <h2>Team Name - {{data['team_name']}}</h2>
                <h2>{{ data['role'].capitalize() }}: {{ user_email }}</h2>
                {% if data['tickets'] %}
                <ul class="ticket-list">
                    {% for ticket in data['tickets'] %}
                    <li class="ticket-item">
                        <strong>Ticket ID - {{ ticket[0] }}</strong><br>
                        <strong>{{ ticket[1] }}</strong>: {{ ticket[2] }}
                        <br>
                        <strong>Description -</strong> {{ ticket[3] }}<br>
                        <strong>Ticket Created:</strong> {{ ticket[4] }}<br>
                        <strong>Expected Date To Close:</strong> {{ ticket[5] }}<br>
                        <strong>Closed Ticket:</strong> {{ ticket[7] }}<br><br>
                        <a href="#" class="view-details"
                            onclick="showAdminTicketDetails('{{ ticket[0] }}', '{{ ticket[10] }}')">View Details</a>
                        <h4>Send Comment to User</h4>
                        <form method="POST" action="{{ url_for('send_comment', ticket_id=ticket[0]) }}">
                            <textarea name="comment" placeholder="Type your comment here..." required></textarea><br>
                            <input type="hidden" name="user_email" value="{{ user_email }}"><br>
                            <input class="view-details" type="submit" value="Send Comment">
                        </form><br>
                        <div class="comments">
                            <button class="btn-admin" onclick="showAdminComments('{{ ticket[0] }}', '{{ user_email }}')">View Admin
                                Comments</button>
                            <div class="admin-comments-section" id="adminComments_{{ ticket[0] }}_{{ user_email }}" style="display: none;">
                                <!-- Admin comments will be populated here -->
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No tickets assigned.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div id="ticketModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="ticketDetails"></div>
            </div>
        </div>

        <div id="attendance-details" class="section" style="display:none;">
            <h3>Attendance Records</h3>
            <div>
                <label for="yearSelect">Year:</label>
                <select id="yearSelect" onchange="updateAttendance()">
                    {% for year in range(2024, 2026) %}
                    <option value="{{ year }}" {% if year==selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>

                <label for="monthSelect">Month:</label>
                <select id="monthSelect" onchange="updateAttendance()">
                    <option value="1" {% if selected_month==1 %}selected{% endif %}>January</option>
                    <option value="2" {% if selected_month==2 %}selected{% endif %}>February</option>
                    <option value="3" {% if selected_month==3 %}selected{% endif %}>March</option>
                    <option value="4" {% if selected_month==4 %}selected{% endif %}>April</option>
                    <option value="5" {% if selected_month==5 %}selected{% endif %}>May</option>
                    <option value="6" {% if selected_month==6 %}selected{% endif %}>June</option>
                    <option value="7" {% if selected_month==7 %}selected{% endif %}>July</option>
                    <option value="8" {% if selected_month==8 %}selected{% endif %}>August</option>
                    <option value="9" {% if selected_month==9 %}selected{% endif %}>September</option>
                    <option value="10" {% if selected_month==10 %}selected{% endif %}>October</option>
                    <option value="11" {% if selected_month==11 %}selected{% endif %}>November</option>
                    <option value="12" {% if selected_month==12 %}selected{% endif %}>December</option>
                </select>

                <div>
                    <label>
                        <input type="radio" name="reportType" value="daily" onchange="updateDownloadLinks()"> Daily
                    </label>
                    <label>
                        <input type="radio" name="reportType" value="monthly" checked onchange="updateDownloadLinks()">
                        Monthly
                    </label>
                    <label>
                        <input type="radio" name="reportType" value="yearly" onchange="updateDownloadLinks()"> Yearly
                    </label>
                </div>

                <!-- Remove the date selection for monthly and yearly downloads -->
                <div id="dailyDateSelection" style="display: none;">
                    <label for="dateSelect">Select Date:</label>
                    <input type="date" id="dateSelect" onchange="updateDownloadLinks()">
                </div>
            </div>
            <input type="text" id="attendanceSearchBar" class="search-bar" placeholder="Search by email or date..."
                oninput="searchAttendance()">

            <button id="downloadDaily" onclick="downloadAttendance('daily')" disabled>Download Daily Attendance</button>
            <button id="downloadMonthly" onclick="downloadAttendance('monthly')" disabled>Download Monthly
                Attendance</button>
            <button id="downloadYearly" onclick="downloadAttendance('yearly')" disabled>Download Yearly
                Attendance</button>

            <table class="attendance-table" id="attendanceTable">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Date</th>
                        <th>Login Time</th>
                        <th>Logout Time</th>
                        <th>Duration Worked</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    {% for record in attendance_records %}
                    <tr>
                        <td>{{ record[1] }}</td> <!-- Email -->
                        <td>{{ record[4] }}</td> <!-- Date -->
                        <td>
                            {% for time in record[2].split(',') %}
                            {{ loop.index }}) {{ time }}<br>
                            {% endfor %}
                        </td> <!-- Login Time -->
                        <td>
                            {% if record[3] is not none %}
                            {% for time in record[3].split(',') %}
                            {{ loop.index }}) {{ time }}<br>
                            {% endfor %}
                            {% else %}
                            No logout times recorded.
                            {% endif %}
                        </td> <!-- Logout Time -->
                        <td>{{ record[5] }}</td> <!-- Duration -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="modal" id="projectDetailsModal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <div id="modalUpdatesContent"></div>
            </div>
        </div>

        <script>
            function showSection(section) {
                const sections = document.querySelectorAll('.section');
                sections.forEach(s => {
                    s.style.display = 'none';
                });
                document.getElementById(section).style.display = 'block';
            }


            function showProjectDetails(projectInfo, teamName, memberEmail) {
                fetch(`/admin_project_details/${projectInfo}/${teamName}/${memberEmail}`)
                    .then(response => response.json())
                    .then(data => {
                        const modalContent = document.getElementById('modalUpdatesContent');

                        // Add styles directly to the modal content
                        const style = document.createElement('style');
                        style.innerHTML = `
                .modal-content {
                    padding: 20px;
                    background-color: #fff;
                    border-radius: 8px;
                    max-width: 900px;
                    margin: 0 auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }

                h3, h4, h5, h6 {
                    font-family: 'Arial', sans-serif;
                    margin-bottom: 10px;
                }

                h4, h5 {
                    color: #007bff;
                }

                .project-details, .assigned-members, .ticket {
                    margin-bottom: 20px;
                    padding: 15px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background-color: #f9f9f9;
                }

                .project-details h3, .assigned-members h4, .tickets h4 {
                    margin-top: 20px;
                    font-size: 18px;
                }

                .project-details {
                    background-color: #e3f2fd;
                    border: 1px solid #2196f3;
                }

                .assigned-members {
                    background-color: #fff3e0;
                    border: 1px solid #ffb74d;
                }

                .ticket {
                    background-color: #f1f8e9;
                    border: 1px solid #388e3c;
                }

                .assigned-members ul {
                    list-style-type: none;
                    padding-left: 0;
                }

                li {
                    margin-bottom: 5px;
                    font-size: 14px;
                }

                p {
                    margin: 5px 0;
                }

                .ticket-updates .update {
                    padding: 10px;
                    border: 1px solid #f1f1f1;
                    border-radius: 4px;
                    margin-bottom: 10px;
                    background-color: #f9f9f9;
                }

                .ticket-updates h6 {
                    margin-bottom: 10px;
                }

                .ticket-actions {
                    display: flex;
                    gap: 10px;
                    margin-top: 10px;
                }

                button {
                    padding: 10px 15px;
                    font-size: 14px;
                    border-radius: 5px;
                    cursor: pointer;
                    border: none;
                }

                button:focus {
                    outline: none;
                }

                button:hover {
                    opacity: 0.8;
                }

                .btn-primary {
                    background-color: #007bff;
                    color: white;
                }

                .btn-primary:hover {
                    background-color: #0056b3;
                }

                .btn-secondary {
                    background-color: #f1f1f1;
                    color: #007bff;
                }

                .btn-secondary:hover {
                    background-color: #e1e1e1;
                }

                .btn-admin {
                    background-color: #28a745;
                    color: white;
                }

                .btn-admin:hover {
                    background-color: #218838;
                }

                .comment-form {
                    margin-top: 10px;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background-color: #f9f9f9;
                }

                .comment-form textarea {
                    width: 90%;
                    padding: 10px;
                    font-size: 14px;
                    border-radius: 5px;
                    border: 1px solid #ccc;
                    margin-bottom: 10px;
                    resize: none; /* Disable resizing */
                }

                .comment-form button {
                    background-color: #007bff;
                    color: white;
                }

                .comments-section, .admin-comments-section {
                    margin-top: 10px;
                    padding-left: 20px;
                    font-size: 14px;
                }

                .comments-section {
                    background-color: #f7f7f7;
                    border-left: 3px solid #007bff;
                    padding: 10px;
                }

                .admin-comments-section {
                    background-color: #f7f7f7;
                    border-left: 3px solid #28a745;
                    padding: 10px;
                }

                .no-updates {
                    font-style: italic;
                    color: #888;
                    text-align: center;
                }

                /* Style for the Ticket Daily Updates section */
                .ticket-daily-updates{
                    padding: 10px;
                    border: 1px solid #f1f1f1;
                    border-radius: 4px;
                    margin-bottom: 10px;
                    background-color: #f9f9f9;
                    display: none; 
                }

                .ticket-daily-updates h4 {
                    margin-bottom: 10px;
                }
                .ticket-daily-updates.show {
                    display: block; /* Show the updates when the button is clicked */
                }

                .ticket-daily-updates p {
                    font-size: 14px;
                }

                .update-item {
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 4px; 
                    background-color: #fff; 
                    margin-bottom: 8px;
                }

                .update-item p {
                    margin: 5px 0;
                }

                .toggle-btn {
                    background-color: #007bff;
                    color: white;
                    border-radius: 5px;
                    padding: 8px 12px;
                    cursor: pointer;
                    border: none;
                }

                .toggle-btn:hover {
                    opacity: 0.8;
                }
            `;
                        document.head.appendChild(style); // Add the styles to the document

                        // Build the HTML content dynamically
                        let content = `
                <div class="project-details">
                    <h3>Project Details</h3>
                    <p><strong>Project Name:</strong> ${data.project[3]}</p>
                    <p><strong>Status:</strong> ${data.project[7]}</p>
                    <p><strong>Project Created On:</strong> ${data.project_creation_date}</p>
                    <p><strong>Project Closed On:</strong> ${data.project[6] ? data.project[6] : 'Not Yet Closed'}</p>
                </div>
            `;

                        // Display assigned members
                        content += `
                <div class="assigned-members">
                    <h3>Assigned Members</h3>
                    ${data.team_member_names.length > 0 ? `
                        <ul>
                            ${data.team_member_names.map((name, index) => `
                                <li><strong>${name}</strong> (${data.team_member_emails[index]})</li>
                            `).join('')}
                        </ul>
                    ` : '<p>No team members assigned to this project.</p>'}
                </div>
            `;

                        // Check if tickets exist and display them
                        if (data.tickets && data.tickets.length > 0) {
                            data.tickets.forEach(ticket => {
                                content += `
                        <div class="ticket">
                            <h4>Ticket - ${ticket[0]}</h4>
                            <p><strong>Module:</strong> ${ticket[2]}</p>
                            <p><strong>Description:</strong> ${ticket[3]}</p>
                            <p><strong>Created On:</strong> ${ticket[6]}</p>
                            <p><strong>Start Date:</strong> ${ticket[4]}</p>
                            <p><strong>Expected Date:</strong> ${ticket[5]}</p>
                            <p><strong>Status:</strong> ${ticket[11]}</p>
                            <p><strong>Ticket Closed On:</strong> ${ticket[7] ? ticket[7] : 'Not Yet Closed'}</p>
                    `;

                                // Add the "Ticket Daily Updates" button
                                content += `
                        <button class="toggle-btn" onclick="toggleDailyUpdates(${ticket[0]})">Ticket Daily Updates</button>
                    `;

                                // Check if updates exist for the ticket
                                if (data.ticket_updates && data.ticket_updates[ticket[0]] && data.ticket_updates[ticket[0]].length > 0) {
                                    content += `
                            <div id="ticket-updates-${ticket[0]}" class="ticket-daily-updates">
                                <h4>Updates for Ticket #${ticket[0]}</h4>
                                ${data.ticket_updates[ticket[0]].map(update => `
                                    <div class="update-item">
                                        <p><strong>Date:</strong> ${update[2]}</p>
                                        <p><strong>Description:</strong> ${update[3]}</p>
                                        <p><strong>Stage:</strong> ${update[4]}</p>
                                        <p><strong>State:</strong> ${update[5]}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                                } else {
                                    content += `<p class="no-updates">No updates available for this ticket.</p>`;
                                }

                                // Adding buttons and comment form for the ticket
                                content += `
                        <div class="ticket-actions">
                            <button class="btn-primary" onclick="showCommentForm(${ticket[0]}, '${memberEmail}')">Comment</button>
                            <button class="btn-secondary" onclick="showComments(${ticket[0]}, '${memberEmail}')">View Comments</button>
                            <button class="btn-admin" onclick="showAdmin('${ticket[0]}', '${memberEmail}')">View Admin Comments</button>
                        </div>

                        <div id="commentForm_${ticket[0]}" class="comment-form" style="display: none;">
                            <textarea id="commentInput_${ticket[0]}" placeholder="Type your comment here..."></textarea>
                            <button class="btn-primary" onclick="sendComment(${ticket[0]}, '${memberEmail}')">Send Comment</button>
                        </div>

                        <div id="comments_${ticket[0]}_${memberEmail}" class="comments-section" style="display: none;">
                            <!-- Comments and replies will be populated here -->
                        </div>

                        <div id="comments_admin_${ticket[0]}_${memberEmail}" class="admin-comments-section" style="display: none;">
                            <!-- Admin comments and replies will be populated here -->
                        </div>
                    `;
                                content += `</div>`; // Close the ticket div
                            });
                        } else {
                            content += '<p>No tickets available for this project.</p>';
                        }

                        // Append the content to the modal
                        modalContent.innerHTML = content;

                        // Show the modal
                        const modal = document.getElementById('projectDetailsModal');
                        modal.classList.add('show'); // Add the 'show' class to display the modal
                        // Close modal when clicking the close button
                        const closeBtn = modal.querySelector('.close');
                        closeBtn.onclick = function () {
                            modal.classList.remove('show');
                        }

                        // Close modal when clicking outside of the modal content
                        modal.onclick = function (event) {
                            if (event.target === modal) {
                                modal.classList.remove('show');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching project details:', error);
                    });
            }

            function toggleDailyUpdates(ticketId) {
                const updatesElement = document.getElementById(`ticket-updates-${ticketId}`);
                if (updatesElement) {
                    updatesElement.classList.toggle('show');
                }
            }


            function closeModal() {
                const modal = document.getElementById('projectDetailsModal');
                modal.classList.remove('show');
            }

            function showCommentForm(ticketId, memberEmail) {
                const commentForm = document.getElementById(`commentForm_${ticketId}`);
                commentForm.style.display = commentForm.style.display === 'block' ? 'none' : 'block';
            }

            function sendComment(ticketId, memberEmail) {
                // Select the textarea element by its ID
                const commentInput = document.querySelector(`#commentInput_${ticketId}`);

                if (!commentInput) {
                    alert("Comment input not found.");
                    return;
                }

                const comment = commentInput.value;

                if (!comment) {
                    alert("Please enter a comment.");
                    return;
                }

                fetch(`/send_comment_userAd/${ticketId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ comment: comment, user_email: memberEmail }) // Ensure user_email is included
                })
                    .then(response => {
                        if (response.redirected) {
                            // Handle redirection if the user is not logged in
                            window.location.href = response.url; // Redirect to login page
                        } else {
                            return response.json();
                        }
                    })
                    .then(data => {
                        if (data && data.success) {
                            // Clear the input and refresh comments
                            commentInput.value = ''; // Clear the textarea
                            // Optionally, refresh the comments section here
                        } else {
                            alert("Error sending comment: " + (data.message || "Unknown error"));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            function showAdmin(ticketId, memberEmail) {
                const commentsDiv = document.getElementById(`comments_admin_${ticketId}_${memberEmail}`);

                if (commentsDiv.style.display === 'block') {
                    commentsDiv.style.display = 'none';
                } else {
                    fetch(`/get_admin_user_comments/${ticketId}/${memberEmail}`)
                        .then(response => response.json())
                        .then(data => {
                            commentsDiv.innerHTML = ''; // Clear previous comments
                            if (data.length === 0) {
                                const noCommentsMessage = document.createElement('div');
                                noCommentsMessage.classList.add('no-comments');
                                noCommentsMessage.innerHTML = '<em>No comments available.</em>';
                                commentsDiv.appendChild(noCommentsMessage);
                            } else {
                                data.forEach(item => {
                                    const commentElement = document.createElement('div');
                                    commentElement.classList.add('comment');
                                    commentElement.innerHTML = `
                            <strong>${item.user} - ${new Date(item.timestamp).toLocaleString()}:</strong>
                            <p>${item.content}</p>
                        `;
                                    commentsDiv.appendChild(commentElement);
                                });
                            }
                            commentsDiv.style.display = 'block'; // Show the comments
                        })
                        .catch(error => {
                            console.error('Error fetching comments:', error);
                        });
                }
            }

            function searchUser() {
                const searchQuery = document.getElementById('searchBar').value.toLowerCase();
                const users = document.querySelectorAll('.user-section');
                users.forEach(user => {
                    const userName = user.textContent.toLowerCase();
                    if (userName.includes(searchQuery)) {
                        user.style.display = 'block';
                    } else {
                        user.style.display = 'none';
                    }
                });
            }


            function searchAttendance() {
                const query = document.getElementById('attendanceSearchBar').value.toLowerCase();
                const rows = document.querySelectorAll('#attendanceTableBody tr');

                rows.forEach(row => {
                    const email = row.cells[0].textContent.toLowerCase();
                    const date = row.cells[1].textContent.toLowerCase();

                    const matchEmail = email.includes(query);
                    const matchDate = date.includes(query);

                    if (matchEmail || matchDate) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            function changeYear() {
                const year = document.getElementById('yearSelect').value;
                const month = document.getElementById('monthSelect').value;
                window.location.href = `?year=${year}&month=${month}`;
            }

            function changeMonth() {
                const year = document.getElementById('yearSelect').value;
                const month = document.getElementById('monthSelect').value;
                window.location.href = `?year=${year}&month=${month}`;
            }

            document.getElementById('monthSelect').addEventListener('change', updateAttendance);
            document.getElementById('yearSelect').addEventListener('change', updateAttendance);

            function updateAttendance() {
                const year = document.getElementById('yearSelect').value;
                const month = document.getElementById('monthSelect').value;

                fetch(`/admin/attendance?year=${year}&month=${month}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const tableBody = document.getElementById('attendanceTableBody');
                        tableBody.innerHTML = ''; // Clear existing records

                        if (data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="5">No records found for this month.</td></tr>';
                            return;
                        }

                        data.forEach(record => {
                            const loginTimes = record.login_time.split(','); // Split login times by comma
                            const logoutTimes = record.logout_time.split(','); // Split logout times by comma

                            const loginTimeHtml = loginTimes.map((time, index) => `${index + 1}) ${time}`).join('<br>'); // Create HTML for login times
                            const logoutTimeHtml = logoutTimes.map((time, index) => `${index + 1}) ${time}`).join('<br>'); // Create HTML for logout times

                            const row = document.createElement('tr');
                            row.innerHTML = `
                    <td>${record.email}</td>
                    <td>${record.date}</td>
                    <td>${loginTimeHtml}</td>
                    <td>${logoutTimeHtml}</td>
                    <td>${record.duration_worked}</td>
                `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching attendance records:', error);
                        const tableBody = document.getElementById('attendanceTableBody');
                        tableBody.innerHTML = '<tr><td colspan="5">Error loading records. Please try again later.</td></tr>';
                    });
            }

            function updateMentors() {
                const teamSelect = document.getElementById('team_name');
                const mentorSelect = document.getElementById('mentor_name');
                const selectedTeam = teamSelect.value;

                // Clear the mentor dropdown
                mentorSelect.innerHTML = '<option value="">Select Mentor/Member</option>';

                // Fetch mentors and team members for the selected team
                if (selectedTeam) {
                    fetch(`/get_mentors_and_members/${selectedTeam}`)
                        .then(response => response.json())
                        .then(data => {
                            // Populate mentors
                            data.mentors.forEach(mentor => {
                                const option = document.createElement('option');
                                option.value = mentor.email;
                                option.textContent = `${mentor.name} (Mentor)`;
                                mentorSelect.appendChild(option);
                            });

                            // Populate team members
                            data.members.forEach(member => {
                                const option = document.createElement('option');
                                option.value = member.email;
                                option.textContent = `${member.name} (Team Member)`;
                                mentorSelect.appendChild(option);
                            });

                            data.researchers.forEach(researcher => {
                                const option = document.createElement('option');
                                option.value = researcher.email;
                                option.textContent = `${researcher.name} (Researchers)`;
                                mentorSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error fetching mentors and members:', error));
                }
            }

            function updateHiddenEmail() {
                const mentorSelect = document.getElementById('mentor_name');
                const hiddenEmailInput = document.getElementById('mentor_email');

                // Set the hidden input value to the selected option's value (email)
                hiddenEmailInput.value = mentorSelect.value;
            }

            function showAdminTicketDetails(ticketId, user_email) {
                const modal = document.getElementById('ticketModal');
                const ticketDetails = document.getElementById('ticketDetails');
                const closeBtn = modal.querySelector('.close');

                ticketDetails.innerHTML = '<p>Loading ticket details...</p>';
                modal.style.display = 'block';

                fetch(`/admin_ticket_updates_display_new/${ticketId}/${user_email}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Create and apply styles for the modal content
                        const style = document.createElement('style');
                        style.innerHTML = `
                .modal-content {
                    padding: 20px;
                    background-color: #fff;
                    border-radius: 8px;
                    max-width: 900px;
                    margin: 0 auto;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }

                h3, h4, h5, h6 {
                    font-family: 'Arial', sans-serif;
                    margin-bottom: 10px;
                }

                h4 {
                    color: #007bff;
                }

                .ticket-details {
                    margin-bottom: 20px;
                    padding: 15px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background-color: #f9f9f9;
                }

                .ticket-details h4 {
                    margin-top: 20px;
                    font-size: 18px;
                }

                .ticket-details p {
                    margin: 5px 0;
                }

                .ticket-updates {
                    margin-top: 20px;
                    padding: 15px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background-color: #f1f8e9;
                }

                .ticket-update {
                    padding: 10px;
                    border: 1px solid #f1f1f1;
                    border-radius: 4px;
                    margin-bottom: 10px;
                    background-color: #f9f9f9;
                }

                .ticket-update p {
                    margin: 5px 0;
                }

                .ticket-actions {
                    display: flex;
                    gap: 10px;
                    margin-top: 10px;
                }

                button {
                    padding: 10px 15px;
                    font-size: 14px;
                    border-radius: 5px;
                    cursor: pointer;
                    border: none;
                }

                button:focus {
                    outline: none;
                }

                button:hover {
                    opacity: 0.8;
                }

                .btn-primary {
                    background-color: #007bff;
                    color: white;
                }

                .btn-primary:hover {
                    background-color: #0056b3;
                }

                .btn-secondary {
                    background-color: #f1f1f1;
                    color: #007bff;
                }

                .btn-secondary:hover {
                    background-color: #e1e1e1;
                }
            `;
                        document.head.appendChild(style);

                        // Dynamically build the content
                        let content = `
                <div class="ticket-details">
                    <h4>Ticket: ${data.ticket[0]}</h4>
                    <p><strong>Description:</strong> ${data.ticket[3]}</p>
                    <p><strong>Created:</strong> ${data.ticket[6]}</p>
                    <p><strong>Started On:</strong> ${data.ticket[4]}</p>
                    <p><strong>Expected To End:</strong> ${data.ticket[5]}</p>
                    <p><strong>Status:</strong> ${data.ticket[11]}</p>
                    <p><strong>Closed On:</strong> ${data.ticket[7] ? data.ticket[7] : 'Not Closed Yet'}</p>
                </div>
                <div class="ticket-updates">
                    <h5>Updates:</h5>
            `;

                        // Check if daily updates exist
                        if (data.daily_updates.length) {
                            data.daily_updates.forEach(update => {
                                content += `
                    <div class="ticket-update">
                        <p><strong>${update[2]}:</strong> ${update[3]}</p>
                        <p><em>Stage: ${update[4]}, State: ${update[5]}</em></p>
                    </div>
                `;
                            });
                        } else {
                            content += '<p>No updates for this ticket.</p>';
                        }

                        content += '</div>';

                        // Display the content in the modal
                        ticketDetails.innerHTML = content;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ticketDetails.innerHTML = '<p>Error loading ticket details. Please try again.</p>';
                    });

                // Close the modal when clicking on the close button
                closeBtn.onclick = function () {
                    modal.style.display = 'none';
                };

                // Close the modal when clicking outside the modal
                window.onclick = function (event) {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                };
            }

        </script>

        <script>
            document.querySelector('#create-tickets form').addEventListener('submit', function (e) {
                const startDate = new Date(document.getElementById('start_date').value);
                const endDate = new Date(document.getElementById('end_date').value);

                // Reset any previous error messages
                const existingError = document.querySelector('.date-error');
                if (existingError) {
                    existingError.remove();
                }

                // Validate dates
                if (startDate > endDate) {
                    e.preventDefault();
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'date-error';
                    errorDiv.style.color = 'red';
                    errorDiv.style.marginBottom = '10px';
                    errorDiv.textContent = 'End date cannot be before start date';
                    document.getElementById('end_date').after(errorDiv);
                }
            });
        </script>

        <script>
            // Function to hide the flash messages after 4 seconds
            window.addEventListener('DOMContentLoaded', (event) => {
                const flashMessages = document.querySelectorAll('.flash-messages');
                flashMessages.forEach((message) => {
                    setTimeout(() => {
                        message.style.display = 'none';
                    }, 4000); // 4000 milliseconds = 4 seconds
                });
            });

            function downloadAttendance(reportType) {
                const year = document.getElementById('yearSelect').value;
                const month = document.getElementById('monthSelect').value;
                let date = document.getElementById('dateSelect').value;

                if (reportType === 'daily') {
                    if (!date) {
                        alert("Please select a date for daily attendance download.");
                        return;
                    }
                    window.location.href = `/admin/download_attendance/daily?date=${date}`;
                } else if (reportType === 'monthly') {
                    window.location.href = `/admin/download_attendance/monthly?year=${year}&month=${month}`;
                } else if (reportType === 'yearly') {
                    window.location.href = `/admin/download_attendance/yearly?year=${year}`;
                } else {
                    alert("Invalid report type selected.");
                }
            }

            function updateDownloadLinks() {
                const reportType = document.querySelector('input[name="reportType"]:checked').value; // Get the selected report type
                const dateSelection = document.getElementById('dailyDateSelection');
                const dailyButton = document.getElementById('downloadDaily');
                const monthlyButton = document.getElementById('downloadMonthly');
                const yearlyButton = document.getElementById('downloadYearly');

                // Hide date selection for monthly and yearly
                if (reportType === 'daily') {
                    dateSelection.style.display = 'block';
                    dailyButton.disabled = false;
                    monthlyButton.disabled = true;
                    yearlyButton.disabled = true;
                } else {
                    dateSelection.style.display = 'none';
                    dailyButton.disabled = true;
                    if (reportType === 'monthly') {
                        monthlyButton.disabled = false;
                        yearlyButton.disabled = true;
                    } else if (reportType === 'yearly') {
                        yearlyButton.disabled = false;
                        monthlyButton.disabled = true;
                    }
                }
            }

            // Call updateDownloadLinks on page load to set the initial state
            window.onload = function () {
                updateDownloadLinks();
            };


            function showAdminComments(ticketId, memberEmail) {
                const commentsDiv = document.getElementById(`adminComments_${ticketId}_${memberEmail}`);

                // Check if the commentsDiv is currently displayed
                if (commentsDiv.style.display === 'block') {
                    // If it is displayed, hide it
                    commentsDiv.style.display = 'none';
                } else {
                    // If it is not displayed, fetch and show comments
                    fetch(`/get_admin_comments/${ticketId}/${memberEmail}`)
                        .then(response => response.json())
                        .then(data => {
                            commentsDiv.innerHTML = ''; // Clear previous comments

                            // Check if there are comments
                            if (data.length === 0) {
                                const noCommentsMessage = document.createElement('div');
                                noCommentsMessage.classList.add('no-comments');
                                noCommentsMessage.innerHTML = '<em>No comments available.</em>';
                                commentsDiv.appendChild(noCommentsMessage);
                            } else {
                                // Render comments and replies
                                data.forEach(item => {
                                    const commentElement = document.createElement('div');
                                    commentElement.classList.add('comment');
                                    commentElement.innerHTML = `
                            <strong>${item.user} - ${new Date(item.timestamp).toLocaleString()}:</strong>
                            <p>${item.content}</p>
                        `;
                                    commentsDiv.appendChild(commentElement);
                                });
                            }

                            commentsDiv.style.display = 'block'; // Show the comments
                        })
                        .catch(error => {
                            console.error('Error fetching admin comments:', error);
                        });
                }
            }

            function showComments(ticketId, memberEmail) {
                const commentsDiv = document.getElementById(`comments_${ticketId}_${memberEmail}`);

                if (commentsDiv.style.display === 'block') {
                    commentsDiv.style.display = 'none';
                } else {
                    fetch(`/get_comments/${ticketId}/${memberEmail}`)
                        .then(response => response.json())
                        .then(data => {
                            commentsDiv.innerHTML = ''; // Clear previous comments

                            if (data.length === 0) {
                                const noCommentsMessage = document.createElement('div');
                                noCommentsMessage.classList.add('no-comments');
                                noCommentsMessage.innerHTML = '<em>No comments available.</em>';
                                commentsDiv.appendChild(noCommentsMessage);
                            } else {
                                data.forEach(item => {
                                    const commentElement = document.createElement('div');
                                    commentElement.classList.add('comment');
                                    commentElement.innerHTML = `
                            <strong>${item.user} - ${new Date(item.timestamp).toLocaleString()}:</strong>
                            <p>${item.content}</p>
                        `;
                                    commentsDiv.appendChild(commentElement);
                                });
                            }

                            commentsDiv.style.display = 'block'; // Show the comments
                        })
                        .catch(error => {
                            console.error('Error fetching comments:', error);
                        });
                }
            }
        </script>
</body>

</html>